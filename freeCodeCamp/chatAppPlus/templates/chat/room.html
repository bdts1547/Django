{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">


    <title>Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://netdna.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'chat/css/room.css' %}">
</head>

<body>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <div class="container">
        <div class="col-md-12 col-lg-6">
            <div class="panel">

                <div class="panel-heading">
                    <div class="panel-control">
                        <div class="btn-group">
                            <button class="btn btn-default" type="button" data-toggle="collapse"
                                data-target="#demo-chat-body"><i class="fa fa-chevron-down"></i></button>
                            <button type="button" class="btn btn-default" data-toggle="dropdown"><i
                                    class="fa fa-gear"></i></button>
                            <ul class="dropdown-menu dropdown-menu-right">
                                <li><a href="#">Available</a></li>
                                <li><a href="#">Busy</a></li>
                                <li><a href="#">Away</a></li>
                                <li class="divider"></li>
                                <li><a id="demo-connect-chat" href="#" class="disabled-link"
                                        data-target="#demo-chat-body">Connect</a></li>
                                <li><a id="demo-disconnect-chat" href="#" data-target="#demo-chat-body">Disconect</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <h3 class="panel-title">Chat</h3>
                </div>

                <div id="demo-chat-body" class="collapse in">
                    <div class="nano has-scrollbar" style="height:380px">
                        <div class="nano-content pad-all" tabindex="0" style="right: -17px;">
                            <ul class="list-unstyled media-block">
                                <div id="display"></div>

                                <!-- <li class="mar-btm">
                                    <div class="media-left">
                                        <img src="https://bootdey.com/img/Content/avatar/avatar1.png"
                                            class="img-circle img-sm" alt="Profile Picture">
                                    </div>
                                    <div class="media-body pad-hor">
                                        <div class="speech">
                                            <a href="#" class="media-heading">John Doe</a>
                                            <p>Hello Lucy, how can I help you today ?</p>
                                            <p class="speech-time">
                                                <i class="fa fa-clock-o fa-fw"></i>09:23AM
                                            </p>
                                        </div>
                                    </div>
                                </li>
                                <li class="mar-btm">
                                    <div class="media-right">
                                        <img src="https://bootdey.com/img/Content/avatar/avatar2.png"
                                            class="img-circle img-sm" alt="Profile Picture">
                                    </div>
                                    <div class="media-body pad-hor speech-right">
                                        <div class="speech">
                                            <a href="#" class="media-heading">Lucy Doe</a>
                                            <p>Hi, I want to buy a new shoes.</p>
                                            <p class="speech-time">
                                                <i class="fa fa-clock-o fa-fw"></i> 09:23AM
                                            </p>
                                        </div>
                                    </div>
                                </li>
                                <li class="mar-btm">
                                    <div class="media-left">
                                        <img src="https://bootdey.com/img/Content/avatar/avatar1.png"
                                            class="img-circle img-sm" alt="Profile Picture">
                                    </div>
                                    <div class="media-body pad-hor">
                                        <div class="speech">
                                            <a href="#" class="media-heading">John Doe</a>
                                            <p>Shipment is free. You\'ll get your shoes tomorrow!</p>
                                            <p class="speech-time">
                                                <i class="fa fa-clock-o fa-fw"></i> 09:25
                                            </p>
                                        </div>
                                    </div>
                                </li>
                                <li class="mar-btm">
                                    <div class="media-right">
                                        <img src="https://bootdey.com/img/Content/avatar/avatar2.png"
                                            class="img-circle img-sm" alt="Profile Picture">
                                    </div>
                                    <div class="media-body pad-hor speech-right">
                                        <div class="speech">
                                            <a href="#" class="media-heading">Lucy Doe</a>
                                            <p>Wow, that\'s great!</p>
                                            <p class="speech-time">
                                                <i class="fa fa-clock-o fa-fw"></i> 09:27
                                            </p>
                                        </div>
                                    </div>
                                </li>
                                <li class="mar-btm">
                                    <div class="media-right">
                                        <img src="https://bootdey.com/img/Content/avatar/avatar2.png"
                                            class="img-circle img-sm" alt="Profile Picture">
                                    </div>
                                    <div class="media-body pad-hor speech-right">
                                        <div class="speech">
                                            <a href="#" class="media-heading">Lucy Doe</a>
                                            <p>Ok. Thanks for the answer. Appreciated.</p>
                                            <p class="speech-time">
                                                <i class="fa fa-clock-o fa-fw"></i> 09:28
                                            </p>
                                        </div>
                                    </div>
                                </li>
                                <li class="mar-btm">
                                    <div class="media-left">
                                        <img src="https://bootdey.com/img/Content/avatar/avatar1.png"
                                            class="img-circle img-sm" alt="Profile Picture">
                                    </div>
                                    <div class="media-body pad-hor">
                                        <div class="speech">
                                            <a href="#" class="media-heading">John Doe</a>
                                            <p>You are welcome! <br> Is there anything else I can do for you today?</p>
                                            <p class="speech-time">
                                                <i class="fa fa-clock-o fa-fw"></i> 09:30
                                            </p>
                                        </div>
                                    </div>
                                </li>
                                <li class="mar-btm">
                                    <div class="media-right">
                                        <img src="https://bootdey.com/img/Content/avatar/avatar2.png"
                                            class="img-circle img-sm" alt="Profile Picture">
                                    </div>
                                    <div class="media-body pad-hor speech-right">
                                        <div class="speech">
                                            <a href="#" class="media-heading">Lucy Doe</a>
                                            <p>Nope, That\'s it.</p>
                                            <p class="speech-time">
                                                <i class="fa fa-clock-o fa-fw"></i> 09:31
                                            </p>
                                        </div>
                                    </div>
                                </li>
                                <li class="mar-btm">
                                    <div class="media-left">
                                        <img src="https://bootdey.com/img/Content/avatar/avatar1.png"
                                            class="img-circle img-sm" alt="Profile Picture">
                                    </div>
                                    <div class="media-body pad-hor">
                                        <div class="speech">
                                            <a href="#" class="media-heading">John Doe</a>
                                            <p>Thank you for contacting us today</p>
                                            <p class="speech-time">
                                                <i class="fa fa-clock-o fa-fw"></i> 09:32
                                            </p>
                                        </div>
                                    </div>
                                </li> -->
                            </ul>
                        </div>
                        <div class="nano-pane">
                            <div class="nano-slider" style="height: 141px; transform: translate(0px, 0px);"></div>
                        </div>
                    </div>

                    <form class="panel-footer" id="panel-submit">
                        {% csrf_token %}
                        <input type="hidden" name="username" id="username" value="{{username}}">
                        <input type="hidden" name="room_id" id="room_id" value="{{room_detail.id}}">
                        <div class="row">
                            <div class="col-xs-9">
                                <input id="message" type="text" placeholder="Enter your text" class="form-control chat-input">
                            </div>
                            <div class="col-xs-3">
                                <button class="btn btn-primary btn-block" type="submit">Send</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="https://netdna.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <!-- <script type="text/javascript" src="{% static 'chat/js/room.js' %}">

    </script> -->

    <script>
        
        $(document).ready(function(){

            setInterval(function(){
                $.ajax({
                    type: 'GET',
                    url: '/getMessages/{{room}}/',
                    success: function(res) {
                        $('#display').empty();

                        for (var key in res.messages) {
                            var other = `
                            <li class="mar-btm">
                                <div class="media-left">
                                    <img src="https://bootdey.com/img/Content/avatar/avatar1.png"
                                        class="img-circle img-sm" alt="Profile Picture">
                                </div>
                                <div class="media-body pad-hor">
                                    <div class="speech">
                                        <a href="#" class="media-heading">${res.messages[key].username}</a>
                                        <p>${res.messages[key].text}</p>
                                        <p class="speech-time">
                                            <i class="fa fa-clock-o fa-fw"></i>${res.messages[key].time_created}
                                        </p>
                                    </div>
                                </div>
                            </li>
                            `;

                            var me = `
                            <li class="mar-btm">
                                <div class="media-right">
                                    <img src="https://bootdey.com/img/Content/avatar/avatar2.png"
                                        class="img-circle img-sm" alt="Profile Picture">
                                </div>
                                <div class="media-body pad-hor speech-right">
                                    <div class="speech">
                                        <a href="#" class="media-heading">${res.messages[key].username}</a>
                                        <p>${res.messages[key].text}</p>
                                        <p class="speech-time">
                                            <i class="fa fa-clock-o fa-fw"></i> ${res.messages[key].time_created}
                                        </p>
                                    </div>
                                </div>
                            </li>
                            `;

                            if (res.messages[key].username == '{{username}}') {
                                $('#display').append(me);
                            }
                            else {
                                $('#display').append(other);
                            }

                        }
                    },
                    error: function() {
                        alert('Error')
                    }
                })
            }, 1000)
        });



        $(document).on('submit', '#panel-submit', function(e) {
            e.preventDefault();
            $.ajax({
                type: 'POST',
                url: '/send',
                data: {
                    username: $('#username').val(),
                    room_id: $('#room_id').val(),
                    message: $('#message').val(),
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                },
                success: function(res) {
                    // alert(res)
                },
                error: function() {
                    alert("Error")
                }
            });
            document.getElementById('message').value = "";
        });
    </script>

</body>

</html>